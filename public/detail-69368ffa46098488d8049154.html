<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Volunteer Ophthalmic Nurse — Boorama</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .container{max-width:900px;margin:28px auto;padding:18px}
    .muted{color:#6b7280}
    .apply-btn{background:#0f766e;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .seha-modal-overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:2000}
    .seha-modal-overlay.open{display:flex}
    .seha-modal{background:#fff;padding:18px;border-radius:10px;max-width:820px;min-width:320px;width:92%;position:relative}
    input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ee}
  </style>
</head>
<body>
  <main class="section">
    <div class="container" data-slug="volunteer-ophthalmic-nurse-boorama">
      <h1 id="title">Volunteer Ophthalmic Nurse - Boorama</h1>
      <p id="excerpt" class="muted">Support outreach and theatre lists; assist with refraction and postoperative follow-up.</p>

      <img id="hero" src="images/here1.png" alt="" style="width:100%;max-height:420px;object-fit:cover;border-radius:8px;margin:14px 0;">

      <h3>Role summary</h3>
      <p id="details" class="muted">Assist clinical teams during outreach and theatre lists, support postoperative care and basic refraction.</p>

      <h4>Requirements</h4>
      <ul id="requirements" class="small-list">
        <li>Registered ophthalmic nurse or midwife with eye training</li>
        <li>Previous outreach or theatre experience preferred</li>
        <li>Valid passport and ability to travel</li>
      </ul>

      <p style="margin-top:12px">
        <button class="apply-btn" id="openApply">Apply now →</button>
        <a href="opportunities.html" style="margin-left:12px">← Back to Opportunities</a>
      </p>
    </div>
  </main>

  <!-- apply modal (same markup as main page) -->
  <div id="applyModal" class="seha-modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="seha-modal">
      <button id="modalClose" class="apply-btn" style="position:absolute;right:12px;top:12px;background:#e6f6f4;color:#0f766e">Close</button>
      <h3 id="applyModalTitle">Apply for opportunity</h3>
      <div id="applyJobMeta" class="muted">Which opportunity: <strong id="applyJobTitle"></strong></div>

      <form id="applyForm" novalidate>
        <div style="display:flex;gap:12px;margin-top:12px">
          <div style="flex:1">
            <label>Full name</label>
            <input id="appName" name="name" type="text" required>
          </div>
          <div style="flex:1">
            <label>Email</label>
            <input id="appEmail" name="email" type="email" required>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:8px">
          <div style="flex:1">
            <label>Location</label>
            <input id="appLocation" name="location" type="text" placeholder="City, Country">
          </div>
          <div style="flex:1">
            <label>Type</label>
            <select id="appType" name="type"><option value="">(select)</option><option>Volunteer</option><option>Internship</option><option>Short-term contract</option><option>Employment</option></select>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Short statement (why you apply)</label>
          <textarea id="appStatement" name="statement" rows="6" required></textarea>
        </div>

        <div style="display:flex;gap:12px;margin-top:8px">
          <div style="flex:1">
            <label>Upload CV (optional)</label>
            <input id="appCV" type="file" accept=".pdf,.doc,.docx">
            <div id="appCVName" class="muted" style="font-size:13px;margin-top:6px"></div>
            <div class="muted small" style="font-size:12px;margin-top:6px">CV WILL NOT BE UPLOADED OR STORED.</div>
          </div>
          <div style="width:160px">
            <label>Available from</label>
            <input id="appStart" name="available" type="text" placeholder="e.g. 2026-05">
          </div>
        </div>

        <div id="applyMsg" class="muted" style="margin-top:8px"></div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button type="submit" class="apply-btn">Submit application</button>
          <button type="button" id="applyCancel" class="apply-btn" style="background:#e6f6f4;color:#0f766e">Cancel</button>
        </div>
      </form>
    </div>
  </div>

<script>
(function(){
  const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:4000' : '';
  const container = document.querySelector('.container');
  const slug = container && container.dataset && container.dataset.slug ? container.dataset.slug : null;

  // page elements
  const openApply = document.getElementById('openApply');
  const applyModal = document.getElementById('applyModal');
  const modalClose = document.getElementById('modalClose');
  const applyCancel = document.getElementById('applyCancel');
  const applyForm = document.getElementById('applyForm');
  const applyJobTitle = document.getElementById('applyJobTitle');
  const appCV = document.getElementById('appCV');
  const appCVName = document.getElementById('appCVName');
  const applyMsg = document.getElementById('applyMsg');

  async function loadDetail(){
    try {
      const resp = await fetch(API_BASE + '/api/opportunities/' + (slug || 'volunteer-ophthalmic-nurse-boorama'));
      if (!resp.ok) return;
      const j = await resp.json();
      const o = j.opportunity;
      if (!o) return;
      document.getElementById('title').textContent = o.title;
      document.getElementById('excerpt').textContent = o.excerpt || '';
      document.getElementById('details').textContent = o.details || o.excerpt || '';
      // optional: requirements if provided in details or meta
      const hero = document.getElementById('hero');
      if (o.meta && o.meta.image) hero.src = o.meta.image;
      if (applyJobTitle) applyJobTitle.textContent = o.title;
      // set apply form default type & other fields from opportunity
      const appType = document.getElementById('appType');
      if (appType && o.type) for (let i=0;i<appType.options.length;i++){ if (appType.options[i].text === o.type){ appType.selectedIndex = i; break; } }
    } catch (err) { console.error(err); }
  }

  function openModal(){ applyModal.classList.add('open'); applyModal.setAttribute('aria-hidden','false'); setTimeout(()=>document.getElementById('appName').focus(),60); }
  function closeModal(){ applyModal.classList.remove('open'); applyModal.setAttribute('aria-hidden','true'); }

  openApply.addEventListener('click', openModal);
  modalClose.addEventListener('click', closeModal);
  applyCancel.addEventListener('click', closeModal);
  applyModal.addEventListener('click', (e)=> { if (e.target === applyModal) closeModal(); });
  document.addEventListener('keydown', (e)=> { if (e.key === 'Escape' && applyModal.classList.contains('open')) closeModal(); });

  // CV preview
  if (appCV) appCV.addEventListener('change', (e)=> { const f = e.target.files && e.target.files[0]; appCVName.textContent = f ? `${f.name} (${Math.round(f.size/1024)} KB)` : ''; });

  // submit
  if (applyForm) {
    applyForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      applyMsg.style.color = '#6b7280'; applyMsg.textContent = '';
      const name = (document.getElementById('appName').value||'').trim();
      const email = (document.getElementById('appEmail').value||'').trim();
      const statement = (document.getElementById('appStatement').value||'').trim();
      if (!name || !email || !statement) { applyMsg.style.color = '#dc2626'; applyMsg.textContent = 'Please complete required fields.'; return; }
      applyMsg.textContent = 'Submitting...';
      const payload = {
        opportunityId: slug || null,
        name, email,
        location: (document.getElementById('appLocation').value||'').trim(),
        type: (document.getElementById('appType').value||'').trim(),
        statement,
        availableFrom: (document.getElementById('appStart').value||'').trim(),
        cvName: (appCV.files && appCV.files[0]) ? appCV.files[0].name : null
      };
      try {
        const resp = await fetch(API_BASE + '/api/opportunities/apply', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await resp.json();
        if (!resp.ok) { applyMsg.style.color = '#dc2626'; applyMsg.textContent = j.message || 'Submission failed'; return; }
        // save locally
        const key = 'seha_applications'; let arr = [];
        try { arr = JSON.parse(localStorage.getItem(key)) || []; } catch(e){}
        arr.unshift({ id: j.application._id, opportunityTitle: j.application.opportunityTitle, createdAt: j.application.createdAt });
        localStorage.setItem(key, JSON.stringify(arr.slice(0,20)));
        applyMsg.style.color = '#0f766e'; applyMsg.textContent = 'Application received — thank you.';
        applyForm.reset(); appCVName.textContent='';
        setTimeout(()=>closeModal(),1200);
      } catch (err) {
        console.error(err); applyMsg.style.color = '#dc2626'; applyMsg.textContent = 'Network error';
      }
    });
  }

  // load details on page load
  loadDetail();
})();
</script>
</body>
</html>
