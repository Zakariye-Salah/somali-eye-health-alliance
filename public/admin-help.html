<!-- public/admin-help.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin â€” Help Inbox</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:0; display:flex; height:100vh; }
    .sidebar { width:320px; border-right:1px solid #eef2f2; overflow:auto; padding:12px; }
    .main { flex:1; display:flex; flex-direction:column; }
    .conv-item { padding:12px; border-radius:10px; margin-bottom:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:flex-start; background:#fff; box-shadow:0 2px 8px rgba(2,6,23,0.04); }
    .conv-item.unread { border-left:4px solid #ef4444; }
    .conv-title { font-weight:600; }
    .conv-sub { color:#6b7280; font-size:13px }
    .messages { padding:12px; flex:1; overflow:auto; background:#fbfdfe }
    .msg { max-width:70%; padding:10px 12px; border-radius:12px; margin-bottom:8px; }
    .msg.user { background:#f3f9f8; align-self:flex-start; }
    .msg.admin { background:#0f766e; color:#fff; align-self:flex-end; }
    .reply { padding:12px; border-top:1px solid #eef2f2; display:flex; gap:8px; }
    .btn { padding:8px 12px; border-radius:8px; border:0; background:#e6f6f4; color:#0f766e; cursor:pointer }
    .btn.primary { background:#0f766e; color:#fff }
    header { padding:12px; border-bottom:1px solid #eef2f2; display:flex; justify-content:space-between; align-items:center; }
  </style>
</head>
<body>
  <div class="sidebar">
    <header><div style="font-weight:700">Help inbox</div><div><button id="refreshBtn" class="btn">Refresh</button></div></header>
    <div id="list"></div>
  </div>
  <div class="main">
    <div style="padding:12px;border-bottom:1px solid #eef2f2;display:flex;align-items:center;gap:12px">
      <div style="font-weight:700" id="convTitle">Select conversation</div>
      <div style="margin-left:auto"><button id="markRead" class="btn">Mark read</button><button id="closeConv" class="btn">Close</button><button id="deleteConv" class="btn">Delete</button></div>
    </div>
    <div class="messages" id="messagesArea">No conversation selected</div>
    <div class="reply">
      <input id="adminReply" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eef2f2" placeholder="Write a reply..."/>
      <button id="sendReply" class="btn primary">Send</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
 const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') 
  ? 'http://localhost:4000' 
  : 'https://somali-eye-health-alliance.onrender.com';    const socket = io(API_BASE);
    const listEl = document.getElementById('list');
    const messagesArea = document.getElementById('messagesArea');
    const convTitleEl = document.getElementById('convTitle');
    const adminReply = document.getElementById('adminReply');
    let conversations = [];
    let selectedId = null;

    async function apiFetch(url, opts={}) {
      opts.headers = opts.headers || {};
      // include token if you have an admin token
      const token = localStorage.getItem('seha_token'); // set this via your admin login flow
      if (token) opts.headers['Authorization'] = 'Bearer ' + token;
      if (opts.body && !opts.headers['Content-Type']) opts.headers['Content-Type'] = 'application/json';
      try {
        const res = await fetch(API_BASE + url, opts);
        const json = await res.json().catch(()=>null);
        return { ok: res.ok, status: res.status, data: json };
      } catch (err) { return { ok:false, error:err }; }
    }

    async function loadList() {
      const r = await apiFetch('/api/help/conversations/admin/list');
      if (!r.ok) { listEl.innerHTML = '<div class="small">Failed to load</div>'; return; }
      conversations = r.data.conversations || [];
      renderList();
    }
    function renderList(){
      listEl.innerHTML = '';
      conversations.forEach(c => {
        const div = document.createElement('div');
        div.className = 'conv-item' + (c.unreadCount ? ' unread' : '');
        div.innerHTML = `<div><div class="conv-title">${c.title}</div><div class="conv-sub">${c.lastMessageText ? c.lastMessageText.slice(0,80) : ''}</div></div><div class="small">${new Date(c.lastMessageAt).toLocaleString()}</div>`;
        div.addEventListener('click', ()=> openConv(c._id));
        listEl.appendChild(div);
      });
    }
    async function openConv(id) {
      selectedId = id;
      const r = await apiFetch('/api/help/conversations/' + encodeURIComponent(id));
      if (!r.ok) { messagesArea.innerHTML = '<div>Failed to load conversation</div>'; return; }
      const conv = r.data.conversation;
      convTitleEl.textContent = conv.title || conv.name || (conv.anonId ? ('Anonymous-'+conv.anonId.slice(-6)) : 'Conversation');
      renderMessages(conv.messages || []);
      // join socket room
      socket.emit('identify', { role:'admin', convId: id });
      // mark read locally
      document.getElementById('markRead').disabled = false;
    }
    function renderMessages(messages) {
      messagesArea.innerHTML = '';
      const wrapper = document.createElement('div');
      wrapper.style.display = 'flex';
      wrapper.style.flexDirection = 'column';
      messages.forEach(m => {
        const d = document.createElement('div');
        d.className = 'msg ' + (m.sender === 'user' ? 'user' : 'admin');
        d.style.alignSelf = (m.sender === 'user') ? 'flex-start' : 'flex-end';
        d.style.background = m.sender === 'user' ? '#f3f9f8' : '#0f766e';
        d.style.color = m.sender === 'user' ? '#033' : '#fff';
        d.style.padding = '10px 12px';
        d.style.borderRadius = '12px';
        d.style.marginBottom = '8px';
        d.textContent = m.text;
        wrapper.appendChild(d);
      });
      messagesArea.appendChild(wrapper);
      messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    document.getElementById('sendReply').addEventListener('click', async ()=> {
      const txt = (adminReply.value || '').trim(); if (!txt || !selectedId) return;
      const r = await apiFetch('/api/help/conversations/' + encodeURIComponent(selectedId) + '/messages', { method:'POST', body: JSON.stringify({ text: txt }) });
      if (!r.ok) { alert('Reply failed'); return; }
      // update local view
      openConv(selectedId);
      adminReply.value = '';
    });

    document.getElementById('markRead').addEventListener('click', async ()=> {
      if (!selectedId) return;
      const r = await apiFetch('/api/help/conversations/' + encodeURIComponent(selectedId) + '/mark-read', { method:'PUT' });
      if (r.ok) loadList();
    });
    document.getElementById('closeConv').addEventListener('click', async ()=> {
      if (!selectedId) return;
      const r = await apiFetch('/api/help/conversations/' + encodeURIComponent(selectedId) + '/close', { method:'PUT' });
      if (r.ok) loadList();
    });
    document.getElementById('deleteConv').addEventListener('click', async ()=> {
      if (!selectedId) return;
      if (!confirm('Delete conversation?')) return;
      const r = await apiFetch('/api/help/conversations/' + encodeURIComponent(selectedId), { method:'DELETE' });
      if (r.ok) { selectedId = null; convTitleEl.textContent = 'Select conversation'; messagesArea.innerHTML=''; loadList(); }
    });
    document.getElementById('refreshBtn').addEventListener('click', loadList);

    // socket updates: new or updated conversation
    socket.on('help.new', (data) => { loadList(); });
    socket.on('help.updated', (data) => { loadList(); if (selectedId && data.conversationId === selectedId) openConv(selectedId); });

    // initial
    loadList();

  </script>
</body>
</html>
